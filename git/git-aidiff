#!/usr/bin/env bash
set -Eeuo pipefail

REPO_NAME="$(basename "$(git rev-parse --show-toplevel)")"
BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD)"
SAFE_BRANCH_NAME="$(echo "$BRANCH_NAME" | sed 's/[^A-Za-z0-9._-]/_/g')"
OUTFILE="/tmp/diff-${REPO_NAME}-${SAFE_BRANCH_NAME}.json"

declare -a EXCLUDE_SPECS=()

# Populate excludes in the CURRENT shell (no pipeline subshell)
while IFS= read -r f; do
  # output: path: linguist-generated: true|false|unspecified
  if git check-attr linguist-generated -- "$f" | grep -q ': true$'; then
    EXCLUDE_SPECS+=(":(exclude)$f")
  fi
done < <(git diff --name-only main...HEAD --)

git diff --no-color --output-indicator-new="+" --output-indicator-old="-" main...HEAD -- . "${EXCLUDE_SPECS[@]}" \
  | jq -R -s '
    split("\n")
    | reduce .[] as $line (
        {current: null, out: []};
        if ($line | startswith("diff --git "))
        then
          (if .current != null then .out += [ .current ] else . end)
          | .current = {
              filepath: (
                $line
                | capture("diff --git a/(?<a>[^ ]+) b/(?<b>[^ ]+)").b
              ),
              diff: "\($line)\n"
            }
        else
          if .current != null then
            .current.diff += "\($line)\n"
          else
            .
          end
        end
      )
      | (if .current != null then .out + [ .current ] else .out end)
      | map(
          .diff |= (
            split("\n")
            | map(select(. != "\\ No newline at end of file"))
            | join("\n")
            | rtrimstr("\n")
          )
        )
  ' > "$OUTFILE"

echo "Wrote diff JSON to $OUTFILE"
