#!/usr/bin/env bash
set -Eeuo pipefail

REPO_NAME="$(basename "$(git rev-parse --show-toplevel)")"
BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD)"
SAFE_BRANCH_NAME="$(echo "$BRANCH_NAME" | sed 's/[^A-Za-z0-9._-]/_/g')"
OUTFILE="/tmp/diff-${REPO_NAME}-${SAFE_BRANCH_NAME}.json"

declare -a EXCLUDE_SPECS=()

# Parse .gitattributes for linguist-generated=true patterns
if [[ -f .gitattributes ]]; then
    while IFS= read -r line || [[ -n "$line" ]]; do
    # Skip comments and empty lines
    [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
    # Check if line has linguist-generated=true
    if [[ "$line" =~ linguist-generated=true ]]; then
      # Extract the pattern (first field)
      pattern=$(awk '{print $1}' <<< "$line")
      EXCLUDE_SPECS+=(":(exclude)$pattern")
    fi
  done < .gitattributes
fi

DIFF_ARGS=(
  --no-color
  --output-indicator-new="+"
  --output-indicator-old="-"
  main...HEAD
  --
  .
)

if ((${#EXCLUDE_SPECS[@]})); then
  DIFF_ARGS+=("${EXCLUDE_SPECS[@]}")
fi

git diff "${DIFF_ARGS[@]}" \
  | jq -R -s '
    split("\n")
    | reduce .[] as $line (
        {current: null, out: []};
        if ($line | startswith("diff --git "))
        then
          (if .current != null then .out += [ .current ] else . end)
          | .current = {
              filepath: (
                $line
                | capture("diff --git a/(?<a>[^ ]+) b/(?<b>[^ ]+)").b
              ),
              diff: "\($line)\n"
            }
        else
          if .current != null then
            .current.diff += "\($line)\n"
          else
            .
          end
        end
      )
      | (if .current != null then .out + [ .current ] else .out end)
      | map(
          .diff |= (
            split("\n")
            | map(select(. != "\\ No newline at end of file"))
            | join("\n")
            | rtrimstr("\n")
          )
        )
  ' > "$OUTFILE"

echo "Wrote diff JSON to $OUTFILE"
